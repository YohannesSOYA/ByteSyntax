<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | CoopMart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }

        .tab:hover {
            color: #fff;
        }

        .tab.active {
            color: #00f0ff;
            border-bottom: 2px solid #00f0ff;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="background-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <div class="container admin-container">
        <div class="admin-header">
            <h1>Dashboard</h1>
            <div>
                <a href="/" class="btn-logout" style="margin-right: 1rem;"><i class="fas fa-external-link-alt"></i> View
                    Site</a>
                <a href="/logout" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('add-parcel')">Add Parcel</div>
            <div class="tab" onclick="switchTab('recent-parcels')">Parcels List</div>
            <div class="tab" onclick="switchTab('messages')">Messages & Forum</div>
        </div>

        <!-- Add Parcel Section -->
        <div id="add-parcel" class="tab-content active">
            <div class="card">
                <h3>Add New Parcel</h3>
                <form id="addParcelForm" class="grid-form">
                    <div class="input-group">
                        <label class="input-label">Tracking Code</label>
                        <input type="text" id="newTracking" placeholder="Scan or type code" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Recipient Name</label>
                        <input type="text" id="newName" placeholder="Full Name" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Phone</label>
                        <input type="text" id="newPhone" placeholder="01x-xxxxxxx" required>
                    </div>
                    <button type="submit" class="btn-add">Add Parcel</button>
                </form>
            </div>
        </div>

        <!-- Parcel List Section -->
        <div id="recent-parcels" class="tab-content">
            <div class="card list-card">
                <h3>Recent Parcels</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Code</th>
                                <th>Recipient</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for parcel in parcels %}
                            <tr id="row-{{ parcel.id }}">
                                <td>{{ parcel.created_at }}</td>
                                <td>{{ parcel.tracking_code }}</td>
                                <td>{{ parcel.recipient_name }}<br><small>{{ parcel.phone_number }}</small></td>
                                <td>
                                    <span class="status-badge status-{{ parcel.status.lower() }}">
                                        {{ parcel.status }}
                                    </span>
                                </td>
                                <td>
                                    {% if parcel.status == 'Pending' %}
                                    <button onclick="updateStatus({{ parcel.id }}, 'Collected')" class="btn-small">
                                        Mark Collected
                                    </button>
                                    {% else %}
                                    <button onclick="updateStatus({{ parcel.id }}, 'Pending')" class="btn-small"
                                        style="background: rgba(255, 100, 100, 0.2); border-color: #ff6b6b; font-size: 0.8rem;">
                                        <i class="fas fa-undo"></i> Revert
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Messages Section -->
        <div id="messages" class="tab-content">
            <div class="card list-card">
                <h3>User Messages</h3>
                <div class="table-responsive">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="width: 15%;">From</th>
                                <th style="width: 35%;">Message</th>
                                <th style="width: 35%;">Admin Reply</th>
                                <th style="width: 15%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for msg in messages %}
                            <tr id="msg-{{ msg.id }}" style="border-bottom: 1px solid var(--glass-border);">
                                <td style="padding: 1rem;">
                                    <strong>{{ msg.name }}</strong><br>
                                    <small style="color: var(--text-muted);">{{ msg.email }}</small><br>
                                    <small style="color: var(--text-muted);">{{ msg.created_at }}</small>
                                </td>
                                <td style="padding: 1rem;">{{ msg.message }}</td>
                                <td style="padding: 1rem;">
                                    {% if msg.reply %}
                                    <div
                                        style="background: rgba(0, 255, 0, 0.1); padding: 0.5rem; border-radius: 4px; border-left: 2px solid #00ff00;">
                                        {{ msg.reply }}
                                    </div>
                                    {% else %}
                                    <div id="reply-box-{{ msg.id }}">
                                        <textarea id="reply-text-{{ msg.id }}" rows="2" placeholder="Write a reply..."
                                            style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); color: #fff; padding: 0.5rem; border-radius: 4px;"></textarea>
                                        <button onclick="sendReply({{ msg.id }})" class="btn-small"
                                            style="margin-top: 0.5rem;">Reply</button>
                                    </div>
                                    {% endif %}
                                </td>
                                <td style="padding: 1rem;">
                                    <button onclick="deleteMessage({{ msg.id }})" class="btn-small"
                                        style="background: rgba(255, 0, 0, 0.2); border: 1px solid red; color: red;">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 2rem;">No messages received.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab Switching Logic
        function switchTab(tabId) {
            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

            // Show selected content
            document.getElementById(tabId).classList.add('active');
            // Add active class to clicked tab (needs a bit more logic to match specific element, simpler to iterate)
            const tabs = document.querySelectorAll('.tab');
            if (tabId === 'add-parcel') tabs[0].classList.add('active');
            if (tabId === 'recent-parcels') tabs[1].classList.add('active');
            if (tabId === 'messages') tabs[2].classList.add('active');
        }

        // Add Parcel Logic
        document.getElementById('addParcelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                tracking_code: document.getElementById('newTracking').value,
                recipient_name: document.getElementById('newName').value,
                phone_number: document.getElementById('newPhone').value
            };

            try {
                const res = await fetch('/api/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const response = await res.json();
                if (res.ok) {
                    alert('Parcel Added!');
                    location.reload();
                } else {
                    alert('Error: ' + response.error);
                }
            } catch (err) {
                alert('Connection Error');
            }
        });

        // Update Parcel Status Logic
        async function updateStatus(id, newStatus) {
            const action = newStatus === 'Collected' ? 'collect' : 'revert';
            if (!confirm(`Confirm ${action} parcel?`)) return;

            try {
                const res = await fetch('/api/update_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, status: newStatus })
                });

                if (res.ok) {
                    location.reload();
                } else {
                    alert('Error updating status');
                }
            } catch (err) {
                alert('Connection Error');
            }
        }

        // Reply Message Logic
        async function sendReply(id) {
            const replyText = document.getElementById(`reply-text-${id}`).value;
            if (!replyText) return alert("Please write a reply.");

            try {
                const res = await fetch('/api/reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, reply: replyText })
                });

                if (res.ok) {
                    alert('Reply sent!');
                    location.reload();
                } else {
                    alert('Error sending reply');
                }
            } catch (err) {
                alert('Connection Error');
            }
        }

        // Delete Message Logic
        async function deleteMessage(id) {
            if (!confirm("Are you sure you want to delete this message?")) return;

            try {
                const res = await fetch('/api/delete_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });

                if (res.ok) {
                    document.getElementById(`msg-${id}`).remove();
                } else {
                    alert('Error deleting message');
                }
            } catch (err) {
                alert('Connection Error');
            }
        }
    </script>
</body>

</html>